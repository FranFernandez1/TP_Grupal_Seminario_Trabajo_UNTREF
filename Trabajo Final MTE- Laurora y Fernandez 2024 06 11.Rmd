---
title: "Trabajo Práctico Grupal - Seminario Mercado de Trabajo y Empleo"
author: "Melisa Laurora y Francisco Fernández"
date: "2024-06-02"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Análisis Brasil

::: {align="justify"}
El siguiente trabajo práctico es condición obligatoria para la promoción
de la materia **Mercado de trabajo y empleo de la Maestría en Generación
y Analisis de Información Estadística de la UNTREF**. El mismo es de
resolución grupal.

#### Fecha de entrega:

Martes 18 de junio. La entrega será un informe en Rmarkdown alojado en
un repositorio de Github que pueda correrse desde cualquier computadora,
con la base datos correspondiente en el directorio de trabajo.

## 1

Abrir y explorar las distintas bases de datos. Describir brevemente
(en 1 párrafo) la metodología con que la encuesta es elaborada y
explicar (en un tabulado) las variables que serán utilizadas en el
TP.

```{r warning=FALSE, message = FALSE,include=FALSE}
# librerias
library(tidyverse)
library(ggplot2)
library(kableExtra)

#Cargar base de datos
base<-readRDS(file='Brasil_T32019.Rda')
summary(base)

```

### PNAD Continua - Encuesta Nacional Continua por Muestra de Hogares

Tiene como objetivo principal seguir las fluctuaciones trimestrales y la
evolución en la inserción de la población en el mercado laboral y
características como edad, sexo y nivel de educación, además de permitir
el estudio del desarrollo socioeconómico del país a través de la
producción de datos anuales sobre otras formas de trabajo. Es una
encuesta integrada de viviendas; con muestreo probabilístico; frecuencia
de divulgación trimestral/ anual; población objetivo compuesta por todas
las personas que viven en hogares privados permanentes en el área
cubierta por la investigación (Grandes Regiones, Unidades de Federación,
20 Regiones Metropolitanas que contienen Municipios Capitales,
Municipios de las Capitales y Región de Desarrollo Integrado de la Gran
Teresina).

Fuente:
<https://www.ibge.gov.br/estatisticas/sociais/trabalho/17270-pnad-continua.html?=&t=o-que-e>

```{r warning=FALSE}
var <- read.csv("Variables.csv")
kable(var)
```

## 2

Estimar y presentar las tasas básicas del mercado de trabajo. Analizar 
brevemente los resultados encontrados.

```{r warning=FALSE}
if (!require('scales')) install.packages('scales'); library('scales')

Cuadro_1.1a <- base %>% 
  summarise(Poblacion         = sum(V1028),
            Ocupados          = sum(V1028[VD4002 == "Pessoas ocupadas"],na.rm=TRUE),
            Desocupados       = sum(V1028[VD4002 == "Pessoas desocupadas"],na.rm=TRUE),
            PEA               = Ocupados + Desocupados,
            Ocupados_demand   = sum(V1028[VD4002 == "Pessoas ocupadas" & V4071 =="Sim"],na.rm=TRUE),
            Suboc_demandante  = sum(V1028[(VD4004 =="Pessoas subocupadas"|VD4004A=="Pessoas subocupadas") & (V4063=="Sim"|V4063A=="Sim"|VD4005=="Pessoas desalentadas")],na.rm=TRUE),#VD4005
            Suboc_no_demand   = sum(V1028[(VD4004 =="Pessoas subocupadas"|VD4004A=="Pessoas subocupadas") & (V4063=="Não"|V4063A=="Não")],na.rm=TRUE),
            Subocupados       =  sum(V1028[(VD4004 =="Pessoas subocupadas"|VD4004A=="Pessoas subocupadas")],na.rm=TRUE),
            'Tasa Actividad'                  = percent(PEA/Poblacion, accuracy = 0.1),
            'Tasa Empleo'                     = percent(Ocupados/Poblacion, accuracy = 0.1),
            'Tasa Desocupacion'               = percent(Desocupados/PEA, accuracy = 0.1),
            'Tasa ocupados demandantes'       = percent(Ocupados_demand/PEA, accuracy = 0.1),
            'Tasa Subocupación'               = percent(Subocupados/PEA, accuracy = 0.1),                       'Tasa Subocupación demandante'    = percent(Suboc_demandante/PEA, accuracy = 0.1),
            'Tasa Subocupación no demandante' = percent(Suboc_no_demand/PEA, accuracy = 0.1))
  
kable(Cuadro_1.1a)
```

## 3

Realizar una operacionalización de los conceptos de Sector Formal y
Sector Informal, de modo de clasificar a toda la población activa en
alguno de estos dos sectores. Explicar qué variables se eligieron y por
qué.

```{r warning=FALSE}


```

## 4

Realizar una operacionalización del concepto de precariedad laboral,
clasificando a toda la población asalariada.

```{r warning=FALSE}

```

## 5

Presentar de forma tabulada la incidencia de la informalidad y la
precariedad en la población ocupada y/o asalariada.

```{r warning=FALSE}
# Join


```

## 6

Analizar la incidencia de la informalidad y la precariedad según sexo y
edad.

```{r warning=FALSE}



```

Consignas para todos los países Analizar brevemente las diferencias en
la estructura demográfica y del mercado de trabajo entre países. Luego
comparar entre países todas las dimensiones estudiadas en las consignas
anteriores. A la hora de realizar comparaciones, tener en cuenta y
reflexionar sobre los distintos criterios adoptados para operacionalizar
los conceptos estudiados para cada fuente de datos.

```{r warning=FALSE}


```

Otras aclaraciones: Describir todas las decisiones metodológicas
realizadas, en cuanto a la operacionalización de conceptos, las
variables utilizadas y el universo de análisis. Tener en cuenta que para
la mayoría de las consignas hay más de una respuesta válida. No es
necesario incluir una revisión de la literatura sobre informalidad y
precariedad en el TP, tan sólo las referencias necesarias para
fundamentar la elección de las variables.
:::

```{r warning=FALSE}

```

------------------------------------------------------------------------

# Análisis España y Reino Unido


## 1) Abrir y explorar las distintas bases de datos. Describir brevemente la metodología con que la encuesta es elaborada y explicar las variables que serán utilizadas en el TP.


La Encuesta de Fuerza de Trabajo de la Unión Europea (EU-LFS de ahora en más) es la encuesta de hogares e individuos más extensa de la Unión Europea. Su objetivo estadístico principal es clasificar a las personas en tres categorías mutuamente excluyentes: empleados,desempleados y personas por fuera de la fuerza de trabajo. Esta encuesta se realiza de forma trimestral en todos los países de la Unión Europea en un formato estandarizado para todos los países, facilitando así la comparación entre ellos. La población a la cual se le puede realizar la encuesta es de 15 años o más.

Las variables a utilizar, tanto para el caso de España como de Reino Unido, serán las siguentes:

```{r}

Variables <- c("WSTATOR", "MAINSTAT", "COEFF", "STAPRO","SIZEFIRM","TEMP","HWOVERPU","SEEKWORK","AVAILBLE","SIGNISAL","SEX","AGE")
Descripcion <- c("Estado laboral durante la semana de referencia", 
                  "Estado laboral general", 
                  "Factor ponderador de la poblacion", 
                  "Estatus Profesional",
                  "Tamaño de la empresa",
                  "Trabajo Temporal o Permanente",
                  "Cantidad de horas extras no pagas durante la semana de referencia",
                  "En búsqueda laboral",
                  "Disponibilidad para empezar a trabajar en las próximas dos semanas",
                  "Percibe regularmente su salario, aunque no asistió al trabajo en la semana de referencia",
                  "Sexo",
                  "Edad")


variable_table <- data.frame(Variable = Variables, Description = Descripcion)

variable_table %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

## 2) Estimar y presentar las tasas básicas del mercado de trabajo. Analizar brevemente los resultados encontrados.


```{r warning=FALSE}

## Cargamos las bases de datos
bbdd_uk=read.csv("reino_unido.csv")

bbdd_espana=read.csv("espana.csv")

## Calculamos los indicadores básicos laborales para España y Reino Unido

Cuadro_2_ESPAÑA <- bbdd_espana %>% 
  summarise(País="España",
            Poblacion             = sum(COEFF*1000, na.rm = TRUE),
            Ocupados              = sum((WSTATOR %in% c(1,2))*(COEFF*1000),na.rm=TRUE),
            #Ocupados_OIT         = sum((ILOSTAT %in% c(1))*(COEFF*1000),na.rm=TRUE),
            Desocupados           = sum((SEEKWORK %in% c(1,2,4))*(COEFF*1000),na.rm=TRUE),
            #Desocupados_OIT      = sum((ILOSTAT %in% c(2))*(COEFF*1000),na.rm=TRUE),
            #Inactivos   = sum((SEEKWORK %in% c(3)|AVAILBLE %in% c(2))*(COEFF*1000),na.rm=TRUE),
            #Inactivos_OIT        = sum((ILOSTAT %in% c(3))*(COEFF*1000),na.rm=TRUE),
            #Menores              = sum((WSTATOR %in% c(9))*(COEFF*1000),na.rm=TRUE),
            PEA                   = Ocupados + Desocupados,
            'Tasa Actividad'      = percent(PEA/Poblacion, accuracy = 0.1),
            'Tasa Empleo'         = percent(Ocupados/Poblacion, accuracy = 0.1),
            'Tasa Desocupacion'   = percent(Desocupados/PEA, accuracy = 0.1)
            )

Cuadro_2_UK <- bbdd_uk %>% 
  summarise(País="Reino Unido",
            Poblacion             = sum(COEFF*1000, na.rm = TRUE),
            Ocupados              = sum((WSTATOR %in% c(1,2))*(COEFF*1000),na.rm=TRUE),
            #Ocupados_OIT         = sum((ILOSTAT %in% c(1))*(COEFF*1000),na.rm=TRUE),
            Desocupados           = sum((SEEKWORK %in% c(1,2,4))*(COEFF*1000),na.rm=TRUE),
            #Desocupados_OIT      = sum((ILOSTAT %in% c(2))*(COEFF*1000),na.rm=TRUE),
            #Inactivos   = sum((SEEKWORK %in% c(3)|AVAILBLE %in% c(2))*(COEFF*1000),na.rm=TRUE),
            #Inactivos_OIT        = sum((ILOSTAT %in% c(3))*(COEFF*1000),na.rm=TRUE),
            #Menores              = sum((WSTATOR %in% c(9))*(COEFF*1000),na.rm=TRUE),
            PEA                   = Ocupados + Desocupados,
            'Tasa Actividad'      = percent(PEA/Poblacion, accuracy = 0.1),
            'Tasa Empleo'         = percent(Ocupados/Poblacion, accuracy = 0.1),
            'Tasa Desocupacion'   = percent(Desocupados/PEA, accuracy = 0.1)
            )

```



```{r warning=FALSE}

# Agregamos separadores de miles 
Cuadro_2_ESPAÑA <- Cuadro_2_ESPAÑA %>% 
  mutate(across(c(Poblacion, Ocupados, Desocupados, PEA), ~ format(., big.mark = ".", decimal.mark = ",")))

Cuadro_2_UK <- Cuadro_2_UK %>%
  mutate(across(c(Poblacion, Ocupados, Desocupados, PEA), ~ format(., big.mark = ".", decimal.mark = ",")))

# Unificar los datasets
Cuadro_Indicadores_Basicos_Union <- bind_rows(Cuadro_2_ESPAÑA, Cuadro_2_UK)

#Visualizamos los indicadores básicos de España y Reino Unido
kable(Cuadro_Indicadores_Basicos_Union, format = "html", table.attr = "class='table table-striped'", caption = "Tasas Básicas del Mercado de Trabajo de España y Reino Unido - 2018. Fuente: EU LFS 2018-Q1") %>%
  kable_styling(full_width = F, position = "center")

```

Podemos observar que España tiene una tasa de actividad bastante similar a Reino Unido, mientras que encontramos diferencias significativas tanto en la tasa de Desocupación, como en la tasa de Empleo. Pongamos por tanto el foco en la tasa de Desocupación: España tiene 16,1% de desocupación en el período analizado, mientras que Reino Unido tiene 3 veces menos, siendo la tasa de 5%. Asimismo, al hacer una comparación de la tasa de Desocupación de España con Brasil, vemos que la de España también resulta ser ampliamente más alta. Posiblemente más adelante en el trabajo podamos observar si estos niveles de desocupación que observamos en España se explica por algún factor relacionado con la edad o el sexo de las personas.


## 3) Realizar una operacionalización de los conceptos de Sector Formal y Sector Informal, de modo de clasificar a toda la población activa en alguno de estos dos sectores. Explicar qué variables se eligieron y por qué.

Para la operacionalización de los conceptos de Sector Formal e Informal se utilizaron múltiples variables de manera conjunta. Estas variables ya fueron detalladas en el punto 1) de este trabajo. Ahora bien, varias de esas variables se utilizaron en simultáneo para construir distintos conceptos o elementos que, a nuestro entender, dan cuenta del sector en la que se enmarca un trabajador/a. 
En primer lugar, utilizamos la variable SIGNISAL, que refiere a la percepción o no del salario completo cuando el trabajador no asistió al trabajo en la semana de referencia. En los casos que SIGNISAL sea 1,2,3 el trabajador no percibió la totalidad de su salario cuando se ausentó del mismo durante la semana de referencia. Creemos que está es ciertamente una medida para identificar informalidad, aunque también precariedad laboral.

Otras variables de importancia utilizadas para la construcción del indicador de Formalidad/Informalidad laboral fueron STAPRO (Estatus Profesional) y SIZEFIRM (Tamaño de la empresa). Estas variables se utilizaron para identificar a los cuentapropistas. En tal sentido, la variable STAPRO debe equivaler a cero y en simultáneo SIZEFIRM a 99. Consideramos que aquellas personas que trabajan por cuenta propia y no tienen empleados a cargo, dependen exclusivamente de su fuerza de trabajo y sin los beneficios y estabilidad laboral que ofrece, en principio, un trabajo bajo relación de dependencia. Por lo tanto, decidimos incorporarlos dentro del sector informal. Queda claro que, al interior de este sector hay realidades muy variadas, con lo cual no en todos los casos es correcto de hablar de informalidad ciertamente. Pero para los propósitos de este trabajo, lo consideramos como una variable de utilidad para acercarnos al fenómeno de la informalidad.

En definitiva, la construcción del indicador de Informalidad utilizó en simultáneo estos 2 elementos: 1) No percepción del salario completo ante ausencia laboral y 2) Cuentapropistas sin empleados. En el caso de cumplir con una de estas dos condiciones, se decide entonces que el trabajador está en el sector Informal.

En todos los casos, se utilizó el factor de expansión COEFF, y la construcción de estos indicadores es tanto para la base de datos de España como para la de Reino Unido. Es importante mencionar que la EU LPS no tiene preguntas respecto del acceso a la salud o a la educación, a diferencia de buena parte de las encuestas latinoamericanas, con lo cual, el indicador de informalidad debe ser construido con variables de índole distinta a las que uno normalmente buscaría en una encuesta de Mercado de Trabajo.


## 4) Realizar una operacionalización del concepto de precariedad laboral, clasificando a toda la población asalariada.


Para el concepto de precarización laboral, utilizamos en primer lugar la variable HWOVERPU, que captura la cantidad de horas extras trabajadas que no fueron pagadas en la semana de referecia por el empleador. En ese sentido, si ya existía una hora extra no paga, lo contabilizamos como precariedad laboral. A su vez, incorporamos otra variable de suma importancia, TEMP, que remite a los contratos de tipo temporario (TEMP=2). Por último, nos parece importante volver a utilizar una variable que entendemos aplica tanto para precarización como para indicar formalidad de la relación laboral, que es la variable SIGNISAL, que refiere a la percepción o no del salario completo cuando el trabajador no asistió al trabajo en la semana de referencia.Como nuestro denominador vamos a utilizar la variable STAPRO para identificar exclusivamente a los empleados y a los trabajadores familiares (código 3 y 4 respectivamente), dejando por fuera a los cuentapropistas en este caso.

Por lo tanto, para identificar a un trabajador en situación de precariedad laboral, se debe cumplir una de tres condiciones: 1) No haber recibido el pago correspondiente a horas extras trabajadas durante la semana de referencia, 2) Tener un contrato laboral de tipo temporal o 3) No percepción del salario completo ante ausencia laboral.


## 5) Presentar de forma tabulada la incidencia de la informalidad y la precariedad en la población ocupada y/o asalariada.


### Informalidad en España y Reino Unido


```{r warning=FALSE}

## Calculamos la formalidad e informalidad en España 

Cuadro_Formalidad_ESPAÑA <- bbdd_espana %>% 
  summarise( Ocupados              = sum((WSTATOR %in% c(1,2))*(COEFF*1000),na.rm=TRUE),
             No_perciben_salario_completo  = sum((SIGNISAL %in% c(1,2,3))*(COEFF*1000),na.rm=TRUE),
             cuenta_propistas = sum( ((STAPRO == 0)&(SIZEFIRM == 99))  *(COEFF*1000),na.rm=TRUE),
             Salario_Parcial_o_Cuenta_propia_sin_empleados = sum( ((SIGNISAL %in% c(1,2,3)) |((STAPRO == 0)&(SIZEFIRM == 99))    ) * (COEFF * 1000), na.rm = TRUE),
             Informales=Salario_Parcial_o_Cuenta_propia_sin_empleados,
             Formales=Ocupados-Informales,
             'Porcentaje de Informalidad'      = percent(Informales/Ocupados, accuracy = 0.1),
             'Porcentaje de Formalidad'      = percent(Formales/Ocupados, accuracy = 0.1),
             País="España"
            )

## Calculamos la formalidad e informalidad en Reino Unido

Cuadro_Formalidad_Reino_Unido <- bbdd_uk %>% 
  summarise( Ocupados              = sum((WSTATOR %in% c(1,2))*(COEFF*1000),na.rm=TRUE),
             No_perciben_salario_completo  = sum((SIGNISAL %in% c(1,2,3))*(COEFF*1000),na.rm=TRUE),
             cuenta_propistas = sum( ((STAPRO == 0)&(SIZEFIRM == 99))  *(COEFF*1000),na.rm=TRUE),
             Salario_Parcial_o_Cuenta_propia_sin_empleados = sum( ((SIGNISAL %in% c(1,2,3)) | ((STAPRO == 0)&(SIZEFIRM == 99)) ) * (COEFF * 1000), na.rm = TRUE),
             Informales=Salario_Parcial_o_Cuenta_propia_sin_empleados,
             Formales=Ocupados-Informales,
             'Porcentaje de Informalidad'      = percent(Informales/Ocupados, accuracy = 0.1),
             'Porcentaje de Formalidad'      = percent(Formales/Ocupados, accuracy = 0.1),
             País="Reino Unido"
            )


```


```{r warning=FALSE}

# Agregamos separadores de miles 
Cuadro_Formalidad_ESPAÑA <- Cuadro_Formalidad_ESPAÑA %>%
  select(País,Ocupados,Formales,Informales,'Porcentaje de Formalidad','Porcentaje de Informalidad') %>% 
  mutate(across(c(Ocupados,Formales,Informales), ~ format(., big.mark = ".", decimal.mark = ",")))

Cuadro_Formalidad_Reino_Unido <- Cuadro_Formalidad_Reino_Unido %>%
  select(País,Ocupados,Formales,Informales,'Porcentaje de Formalidad','Porcentaje de Informalidad') %>% 
  mutate(across(c(Ocupados,Formales,Informales), ~ format(., big.mark = ".", decimal.mark = ",")))

# Unificar los datasets
Cuadro_Formalidad_Union <- bind_rows(Cuadro_Formalidad_ESPAÑA, Cuadro_Formalidad_Reino_Unido)

#Visualizamos los indicadores adicionales de Formalidad e Informalidad en España y Reino Unido
kable(Cuadro_Formalidad_Union, format = "html", table.attr = "class='table table-striped'", caption = "Indicadores Adicionales del Mercado de Trabajo de España y Reino Unido - 2018. Fuente: EU LFS 2018-Q1") %>%
  kable_styling(full_width = F, position = "center")

```

``` {r warning=FALSE}
library(ggplot2)
library(gridExtra)

# Convertir porcentajes a números sin el símbolo de porcentaje y preparar los datos
data <- Cuadro_Formalidad_Union %>%
  select(País, 'Porcentaje de Formalidad', 'Porcentaje de Informalidad') %>%
  pivot_longer(cols = c('Porcentaje de Formalidad', 'Porcentaje de Informalidad'),
               names_to = "Tipo",
               values_to = "Porcentaje") %>%
  mutate(Porcentaje = as.numeric(gsub("%", "", Porcentaje)))

# Función para crear gráficos de torta con porcentajes dentro de los segmentos
create_pie_chart <- function(df, country) {
  ggplot(df %>% filter(País == country), aes(x = "", y = Porcentaje, fill = Tipo)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    theme_void() +
    ggtitle(paste("Formalidad e Informalidad en", country)) +
    scale_fill_manual(values = c("Porcentaje de Formalidad" = "#B3CDE3", "Porcentaje de Informalidad" = "#FBB4AE")) +
    geom_text(aes(label = paste0(Porcentaje, "%")), position = position_stack(vjust = 0.5)) +  # Mostrar porcentajes dentro de los segmentos
    theme(legend.position = "right",
          plot.title = element_text(size = 12, face = "bold"))  # Ajustar el tamaño del título
}

# Crear los gráficos con porcentajes dentro de los segmentos
pie_chart_espana <- create_pie_chart(data, "España")
pie_chart_reino_unido <- create_pie_chart(data, "Reino Unido")

# Mostrar los gráficos lado a lado
grid.arrange(pie_chart_espana, pie_chart_reino_unido, ncol = 2, widths = c(1.5, 1.5), heights = c(1, 1.2))

```

En  base a la construcción del indicador de formalidad e informalidad laboral en estas bases de datos, podemos observar que ambos países tienen porcentajes relativamente similares en términos de informalidad.Sorprende que Reino Unido tiene un punto porcentual más de porcentaje de Informalidad que España. Por otro lado, en términos absolutos Reino Unido casi duplica a España tanto en cantidad de Ocupados, trabajadores formales e informales, aunque en principio nos interesan más los porcentajes, dado que permiten comparar mejor las formas de trabajo formal e informal entre ambos países. Veamos ahora que sucede con la precarización laboral.

### Precarización Laboral en España y Reino Unido


```{r warning=FALSE}

## Calculamos la precarización laboral en España 

Cuadro_Precarizacion_ESPAÑA <- bbdd_espana %>% 
  summarise( Empleados              = sum((STAPRO %in% c(3,4))*(COEFF*1000),na.rm=TRUE),
             Temporales             = sum((TEMP == 2 )*(COEFF*1000),na.rm=TRUE),
             Sin_pago_horas_extra   = sum((HWOVERPU >= 1 & HWOVERPU <= 98) * (COEFF * 1000), na.rm = TRUE),
             No_perciben_salario_completo  = sum((SIGNISAL %in% c(1,2,3))*(COEFF*1000),na.rm=TRUE),
             Temporales_o_SinPagoHSEXTRA_sin_salario_completo = sum(((TEMP == 2 )| (HWOVERPU >= 1 & HWOVERPU <= 98) | (SIGNISAL %in% c(1,2,3)))*(COEFF*1000),na.rm=TRUE),
             Precarizados=Temporales_o_SinPagoHSEXTRA_sin_salario_completo,
             No_Precarizados=Empleados-Precarizados,
             'Porcentaje de Precarizados'      = percent(Precarizados/Empleados, accuracy = 0.1),
             'Porcentaje de No Precarizados'   = percent(No_Precarizados/Empleados, accuracy = 0.1),
             País="España"
            )

## Calculamos la precarización laboral en Reino Unido

Cuadro_Precarizacion_Reino_Unido <- bbdd_uk %>% 
  summarise( Empleados              = sum((STAPRO %in% c(3,4))*(COEFF*1000),na.rm=TRUE),
             Temporales             = sum((TEMP == 2 )*(COEFF*1000),na.rm=TRUE),
             Sin_pago_horas_extra   = sum((HWOVERPU >= 1 & HWOVERPU <= 98) * (COEFF * 1000), na.rm = TRUE),
             No_perciben_salario_completo  = sum((SIGNISAL %in% c(1,2,3))*(COEFF*1000),na.rm=TRUE),
             Temporales_o_SinPagoHSEXTRA_sin_salario_completo = sum(((TEMP == 2 )| (HWOVERPU >= 1 & HWOVERPU <= 98) | (SIGNISAL %in% c(1,2,3)))*(COEFF*1000),na.rm=TRUE),
             Precarizados=Temporales_o_SinPagoHSEXTRA_sin_salario_completo,
             No_Precarizados=Empleados-Precarizados,
             'Porcentaje de Precarizados'      = percent(Precarizados/Empleados, accuracy = 0.1),
             'Porcentaje de No Precarizados'   = percent(No_Precarizados/Empleados, accuracy = 0.1),
             País="Reino Unido"
            )

```

```{r warning=FALSE}

# Agregamos separadores de miles 
Cuadro_Precarizacion_ESPAÑA <- Cuadro_Precarizacion_ESPAÑA %>%
  select(País,Empleados,No_Precarizados,Precarizados,'Porcentaje de No Precarizados','Porcentaje de Precarizados') %>% 
  mutate(across(c(Empleados,Precarizados,No_Precarizados), ~ format(., big.mark = ".", decimal.mark = ",")))

Cuadro_Precarizacion_Reino_Unido <- Cuadro_Precarizacion_Reino_Unido %>%
  select(País,Empleados,No_Precarizados,Precarizados,'Porcentaje de No Precarizados','Porcentaje de Precarizados') %>% 
  mutate(across(c(Empleados,Precarizados,No_Precarizados), ~ format(., big.mark = ".", decimal.mark = ",")))

# Unificar los datasets
Cuadro_Precarizacion_Union <- bind_rows(Cuadro_Precarizacion_ESPAÑA, Cuadro_Precarizacion_Reino_Unido)

#Visualizamos los indicadores de Precarización Laboral en España y Reino Unido
kable(Cuadro_Precarizacion_Union, format = "html", table.attr = "class='table table-striped'", caption = "Indicadores de Precarización del Mercado de Trabajo de España y Reino Unido - 2018. Fuente: EU LFS 2018-Q1") %>%
  kable_styling(full_width = F, position = "center")

```

```{r}
# Convertir porcentajes a números sin el símbolo de porcentaje y preparar los datos
data <- Cuadro_Precarizacion_Union %>%
  select(País, 'Porcentaje de No Precarizados', 'Porcentaje de Precarizados') %>%
  pivot_longer(cols = c('Porcentaje de No Precarizados', 'Porcentaje de Precarizados'),
               names_to = "Tipo",
               values_to = "Porcentaje") %>%
  mutate(Porcentaje = as.numeric(gsub("%", "", Porcentaje)))

# Función para crear gráficos de torta con porcentajes dentro de los segmentos
create_pie_chart <- function(df, country) {
  ggplot(df %>% filter(País == country), aes(x = "", y = Porcentaje, fill = Tipo)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    theme_void() +
    ggtitle(paste("Precarización Laboral en", country)) +
    scale_fill_manual(values = c("Porcentaje de No Precarizados" = "#B3CDE3", "Porcentaje de Precarizados" = "#FBB4AE")) +
    geom_text(aes(label = paste0(Porcentaje, "%")), position = position_stack(vjust = 0.5)) +  # Mostrar porcentajes dentro de los segmentos
    theme(legend.position = "right",
          plot.title = element_text(size = 12, face = "bold"))  # Ajustar el tamaño del título
}

# Crear los gráficos con porcentajes dentro de los segmentos
pie_chart_espana <- create_pie_chart(data, "España")
pie_chart_reino_unido <- create_pie_chart(data, "Reino Unido")

# Mostrar los gráficos lado a lado
grid.arrange(pie_chart_espana, pie_chart_reino_unido, ncol = 2, widths = c(1.5, 1.5), heights = c(1, 1.2))
```

Analizando la precarización laboral en ambos países, ahora sí es posible ver diferencias más notorias, que a su vez van en la línea con lo esperado. En ese sentido, vemos que el porcentaje de Precarizados en España es notablemente mayor que en el Reino Unido, de hecho es casi 50% mayor. Nuevamente, en términos absolutos Reino Unido duplica a España en Empleados y No Precarizados, pero claro ya no en cantidad de personas precarizadas, siendo los números casi similares en términos absolutos.


## 6 Analizar la incidencia de la informalidad y la precariedad según sexo y edad.

En primer lugar construimos las pirámides poblacionales de ambos países para tener una idea inicial de sus estructuras poblacionales por edad y género.

```{r warning=FALSE}

## Cálculo de datos para Pirámide Poblacional de España

# Transformar los valores de SEX a "Hombre" y "Mujer"
bbdd_espana2 <- bbdd_espana %>%
  mutate(Sexo = ifelse(SEX == 1, "Hombre", "Mujer"))

# Crear intervalos de edad en la base de datos
bbdd_espana2 <- bbdd_espana2 %>%
  mutate(Edad_Grupo = cut(AGE, breaks = seq(0, 100, by = 10), right = FALSE, labels = c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80-89", "90+")))

# Asegurar que Edad_Grupo es un factor
bbdd_espana2$Edad_Grupo <- as.factor(bbdd_espana2$Edad_Grupo)

# Agrupar los datos por intervalos de edad y sexo considerando el factor de expansión
edad_sexo <- bbdd_espana2 %>%
  group_by(Edad_Grupo, Sexo) %>%
  summarise(Count = sum(COEFF * 1000, na.rm = TRUE)) %>%
  ungroup()



# Crear gráfico de pirámide poblacional de España
ggplot(data = edad_sexo, aes(x = Edad_Grupo, y = ifelse(Sexo == "Hombre", -Count, Count), fill = Sexo)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_y_continuous(labels = function(x) format(abs(x), big.mark = ".", decimal.mark = ".", scientific = FALSE)) +
  labs(y = "Cantidad de Personas", x = "Grupo de Edad", title = "Pirámide Poblacional por Edad y Género en España") +
  theme_minimal() +
  scale_fill_manual(values = c("Hombre" = "#77dd77", "Mujer" = "#cba0dc"))


```
```{r warning=FALSE}

## Cálculo de datos para Pirámide Poblacional de Reino Unido

# Transformar los valores de SEX a "Hombre" y "Mujer"
bbdd_uk2 <- bbdd_uk %>%
  mutate(Sexo = ifelse(SEX == 1, "Hombre", "Mujer"))

# Crear intervalos de edad en la base de datos
bbdd_uk2 <- bbdd_uk2 %>%
  mutate(Edad_Grupo = cut(AGE, breaks = seq(0, 100, by = 10), right = FALSE, labels = c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80-89", "90+")))

# Asegurar que Edad_Grupo es un factor
bbdd_uk2$Edad_Grupo <- as.factor(bbdd_uk2$Edad_Grupo)

# Agrupar los datos por intervalos de edad y sexo considerando el factor de expansión
edad_sexo_uk <- bbdd_uk2 %>%
  group_by(Edad_Grupo, Sexo) %>%
  summarise(Count = sum(COEFF * 1000, na.rm = TRUE)) %>%
  ungroup()

# Crear gráfico de pirámide poblacional de Reino Unido
ggplot(data = edad_sexo_uk, aes(x = Edad_Grupo, y = ifelse(Sexo == "Hombre", -Count, Count), fill = Sexo)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_y_continuous(labels = function(x) format(abs(x), big.mark = ".", scientific = FALSE)) +
  labs(y = "Cantidad de Personas", x = "Grupo de Edad", title = "Pirámide Poblacional por Edad y Género en Reino Unido") +
  theme_minimal() +
  scale_fill_manual(values = c("Hombre" = "#77dd77", "Mujer" = "#cba0dc"))

```

Podemos observar que España tiene una parte significativa de su población entre los 30 y los 60 años, es decir en su edad económicamente activa. Aunque también es posible afirmar que tiene una población bastante envejecida al analizar la cantidad de personas mayores a 70 años, no deja de llamar la atención que una parte significativa de su población, las barras más importantes de la pirámide población se encuentran en el medio de la pirámide, lo cual resulta algo sorpresivo para un país europeo. Esto puede deberse a una multiplicidad de factores como la inmigración, que no vienen al caso para este trabajo. 

Por otra parte, la pirámide poblacional de Reino Unido nos revela una típica población envejecida, con una forma de cóncava o de bala, donde a su vez una parte muy importante de su población se encuentra cerca o ya en estado inactivo por su edad.

Ahora bien, pasemos a analizar la incidencia de la informalidad y la precariedad laboral en estas poblaciones.


```{r}

## Transformamos las variables Sexo y Edad

bbdd_espana3 <- mutate(bbdd_espana,
                      Edad_Periodo = cut(AGE,
                                         breaks = c(15, 30, 45, 60, Inf),
                                         labels = c("15-30", "30-45", "45-60", "60 o más"),
                                         include.lowest = TRUE))%>%
  filter(!is.na(Edad_Periodo))  

bbdd_espana3 <- bbdd_espana3 %>%
  mutate(Sexo = case_when(
    SEX == 1 ~ "Hombre",
    SEX == 2 ~ "Mujer",
    TRUE ~ as.character(SEX)  
  ))

## Calculamos la informalidad por Sexo y Edad
Cuadro_Formalidad_ESPAÑA2 <- bbdd_espana3 %>% 
  group_by(Edad_Periodo, Sexo) %>%  # Agrupar por edad y sexo
  summarise(
    Ocupados = sum((WSTATOR %in% c(1, 2)) * (COEFF * 1000), na.rm = TRUE),
    No_perciben_salario_completo = sum((SIGNISAL %in% c(1, 2, 3)) * (COEFF * 1000), na.rm = TRUE),
    cuenta_propistas = sum(((STAPRO == 0) & (SIZEFIRM == 99)) * (COEFF * 1000), na.rm = TRUE),
    Salario_Parcial_o_Cuenta_propia_sin_empleados = sum(((SIGNISAL %in% c(1, 2, 3)) | ((STAPRO == 0) & (SIZEFIRM == 99))) * (COEFF * 1000), na.rm = TRUE),
    Informales = Salario_Parcial_o_Cuenta_propia_sin_empleados,
    Formales = Ocupados - Informales,
    'Porcentaje de Informalidad' = percent(Informales / Ocupados, accuracy = 0.1),
    'Porcentaje de Formalidad' = percent(Formales / Ocupados, accuracy = 0.1),
    País = "España"
  )

# Formatear y redondear las columnas
Cuadro_Formalidad_ESPAÑA2 <- Cuadro_Formalidad_ESPAÑA2 %>%
  select(País, Edad_Periodo, Sexo, Ocupados, Formales, Informales, 'Porcentaje de Formalidad', 'Porcentaje de Informalidad') %>% 
  mutate(
    across(c(Ocupados, Formales, Informales), ~ round(., digits = 0)),  # Redondear a enteros
    across(c(Ocupados, Formales, Informales), ~ format(., big.mark = ".", decimal.mark = ","))
  )

# Visualizar los indicadores en formato HTML
kable(Cuadro_Formalidad_ESPAÑA2, format = "html", table.attr = "class='table table-striped'", caption = "Indicadores de Formalidad e Informalidad del Mercado de Trabajo de España según Sexo y Edad - 2018. Fuente: EU LFS 2018-Q1") %>%
  kable_styling(full_width = F, position = "center")

```


Del cuadro anterior es posible extraer que en España el porcentaje de Informalidad tiene a ser mayor para los hombres que para las mujeres. A su vez, en la medida que aumenta la edad, la informalidad tiende a crecer de manera de constante para ambos sexos. De tal forma que, por ejemplo, mientras la informalidad para Hombres y Mujeres de los 15 a los 30 años es de 11,2% y 7,4% respectivamente, en el rango de edades de 60 o más estos números más que se duplican pasando al 25,2% en los hombres y al 20,8% para las mujeres. Veamos qué sucede con el Reino Unido. 



```{r}

## Transformamos las variables Sexo y Edad

bbdd_uk3 <- mutate(bbdd_uk,
                      Edad_Periodo = cut(AGE,
                                         breaks = c(15, 30, 45, 60, Inf),
                                         labels = c("15-30", "30-45", "45-60", "60 o más"),
                                         include.lowest = TRUE))%>%
  filter(!is.na(Edad_Periodo))  

bbdd_uk3 <- bbdd_uk3 %>%
  mutate(Sexo = case_when(
    SEX == 1 ~ "Hombre",
    SEX == 2 ~ "Mujer",
    TRUE ~ as.character(SEX)  
  ))

## Calculamos la informalidad por Sexo y Edad
Cuadro_Formalidad_UK2 <- bbdd_uk3 %>% 
  group_by(Edad_Periodo, Sexo) %>%  # Agrupar por edad y sexo
  summarise(
    Ocupados = sum((WSTATOR %in% c(1, 2)) * (COEFF * 1000), na.rm = TRUE),
    No_perciben_salario_completo = sum((SIGNISAL %in% c(1, 2, 3)) * (COEFF * 1000), na.rm = TRUE),
    cuenta_propistas = sum(((STAPRO == 0) & (SIZEFIRM == 99)) * (COEFF * 1000), na.rm = TRUE),
    Salario_Parcial_o_Cuenta_propia_sin_empleados = sum(((SIGNISAL %in% c(1, 2, 3)) | ((STAPRO == 0) & (SIZEFIRM == 99))) * (COEFF * 1000), na.rm = TRUE),
    Informales = Salario_Parcial_o_Cuenta_propia_sin_empleados,
    Formales = Ocupados - Informales,
    'Porcentaje de Informalidad' = percent(Informales / Ocupados, accuracy = 0.1),
    'Porcentaje de Formalidad' = percent(Formales / Ocupados, accuracy = 0.1),
    País = "Reino Unido"
  )

# Formatear y redondear las columnas
Cuadro_Formalidad_UK2 <- Cuadro_Formalidad_UK2 %>%
  select(País, Edad_Periodo, Sexo, Ocupados, Formales, Informales, 'Porcentaje de Formalidad', 'Porcentaje de Informalidad') %>% 
  mutate(
    across(c(Ocupados, Formales, Informales), ~ round(., digits = 0)),  # Redondear a enteros
    across(c(Ocupados, Formales, Informales), ~ format(., big.mark = ".", decimal.mark = ","))
  )

# Visualizar los indicadores en formato HTML
kable(Cuadro_Formalidad_UK2, format = "html", table.attr = "class='table table-striped'", caption = "Indicadores de Formalidad e Informalidad del Mercado de Trabajo de Reino Unido según Sexo y Edad - 2018. Fuente: EU LFS 2018-Q1") %>%
  kable_styling(full_width = F, position = "center")

```

Al igual que en el caso de España, los hombres en Reino Unido tienden a tener un nivel de informalidad más alto que las mujeres en todos los grupos de edad. Y también muy en línea con lo que vimos para España, en Reino Unido la edad también es un factor clave para entender el fenómeno de la informalidad. Al aumentar la edad la informalidad crece, y de forma mucho más marcada que en el caso español. Retomando un ejemplo similar, en el grupo de edad de 15 a 30 la informalidad para hombres es de 10,9% y de 7,3% para las mujeres (nótese la similitud de los porcentajes con España). Ahora bien, al analizar el grupo de edad mayor (60 o más años) la informalidad se triplica para ambos géneros: pasa al 32,1% en Hombres y al 21,7% en mujeres.

Analicemos por último el fenómeno de la precariedad laboral.



